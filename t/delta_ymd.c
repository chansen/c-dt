#include "dt.h"
#include "tap.h"

const struct test {
    int y1;
    int m1;
    int d1;
    int y2;
    int m2;
    int d2;
    int ny;
    int nm;
    int nd;
} tests[] = {
    {2010,  1,  1, 2010,  1,  1,  0,   0,   0},
    {2010,  1,  1, 2010,  1,  2,  0,   0,   1},
    {2010,  1,  1, 2010,  1, 31,  0,   0,  30},
    {2010,  1,  1, 2010,  2,  1,  0,   1,   0},
    {2010,  1,  1, 2010,  2, 28,  0,   1,  27},
    {2010,  1,  1, 2010,  3,  1,  0,   2,   0},
    {2010,  1,  1, 2010, 12, 31,  0,  11,  30},
    {2010,  1,  1, 2011,  1,  1,  1,   0,   0},
    {2010,  1,  1, 2011, 12, 31,  1,  11,  30},
    {2010,  1,  1, 2012,  1,  1,  2,   0,   0},
    {2010,  1, 10, 2010,  1,  1,  0,   0,  -9},
    {2010,  1, 10, 2010,  1,  2,  0,   0,  -8},
    {2010,  1, 10, 2010,  1,  9,  0,   0,  -1},
    {2010,  1, 10, 2010,  1, 10,  0,   0,   0},
    {2010,  1, 10, 2010,  1, 11,  0,   0,   1},
    {2010,  1, 10, 2010,  1, 31,  0,   0,  21},
    {2010,  1, 10, 2010,  2,  1,  0,   0,  22},
    {2010,  1, 10, 2010,  2,  9,  0,   0,  30},
    {2010,  1, 10, 2010,  2, 10,  0,   1,   0},
    {2010,  1, 10, 2010,  2, 28,  0,   1,  18},
    {2010,  1, 10, 2010,  3,  1,  0,   1,  19},
    {2010,  1, 10, 2010,  3,  9,  0,   1,  27},
    {2010,  1, 10, 2010,  3, 10,  0,   2,   0},
    {2010,  1, 10, 2010, 12, 31,  0,  11,  21},
    {2010,  1, 10, 2011,  1,  1,  0,  11,  22},
    {2010,  1, 10, 2011,  1,  9,  0,  11,  30},
    {2010,  1, 10, 2011,  1, 10,  1,   0,   0},
    {2010,  3, 30, 2011,  5,  1,  1,   1,   1},
    {2010,  4, 30, 2011,  5,  1,  1,   0,   1},
    {2010,  2, 28, 2012,  2, 27,  1,  11,  30},
    {2010,  2, 28, 2012,  2, 28,  2,   0,   0},
    {2010,  2, 28, 2012,  2, 29,  2,   0,   1},
    {2012,  2, 28, 2014,  2, 27,  1,  11,  30},
    {2012,  2, 28, 2014,  2, 28,  2,   0,   0},
    {2012,  2, 28, 2014,  3,  1,  2,   0,   1},
    {2012,  2, 29, 2014,  2, 28,  1,  11,  30},
    {2012,  2, 29, 2014,  3,  1,  2,   0,   1},
    {2012,  2, 29, 2014,  3,  2,  2,   0,   2},
    {2012,  2, 29, 2016,  2, 28,  3,  11,  30},
    {2012,  2, 29, 2016,  2, 29,  4,   0,   0},
    {2012,  2, 29, 2016,  3,  1,  4,   0,   1},
    {2010,  1,  1, 2009, 12, 31,  0,   0,  -1},
    {2010,  1,  1, 2009, 12, 30,  0,   0,  -2},
    {2010,  1,  1, 2009, 12,  2,  0,   0, -30},
    {2010,  1,  1, 2009, 12,  1,  0,  -1,   0},
    {2010,  1,  1, 2009, 11, 30,  0,  -1,  -1},
    {2010,  1,  1, 2009, 11,  2,  0,  -1, -29},
    {2010,  1,  1, 2009, 11,  1,  0,  -2,   0},
    {2010,  1,  1, 2009,  1,  2,  0, -11, -30},
    {2010,  1,  1, 2009,  1,  1, -1,   0,   0},
    {2010,  1, 15, 2010,  1, 15,  0,   0,   0},
    {2010,  1, 15, 2010,  1, 14,  0,   0,  -1},
    {2010,  1, 15, 2010,  1,  1,  0,   0, -14},
    {2010,  1, 15, 2009, 12, 31,  0,   0, -15},
    {2010,  1, 15, 2009, 12, 16,  0,   0, -30},
    {2010,  1, 15, 2009, 12, 15,  0,  -1,   0},
    {2010,  1, 15, 2009, 12, 14,  0,  -1,  -1},
    {2010,  2, 28, 2009,  3,  1,  0, -11, -27},
    {2010,  2, 28, 2009,  2, 28, -1,   0,   0},
    {2010,  2, 28, 2009,  2, 27, -1,   0,  -1},
    {2010,  2, 28, 2008,  2, 29, -1, -11, -28},
    {2010,  2, 28, 2008,  2, 28, -2,   0,   0},
    {2010,  2, 28, 2008,  2, 27, -2,   0,  -1},
    {2012,  2, 29, 2009,  3,  1, -2, -11, -28},
    {2012,  2, 29, 2009,  2, 28, -3,   0,  -1},
    {2012,  2, 29, 2009,  2, 27, -3,   0,  -2},
    {2012,  2, 29, 2008,  3,  1, -3, -11, -28},
    {2012,  2, 29, 2008,  2, 29, -4,   0,   0},
    {2012,  2, 29, 2008,  2, 28, -4,   0,  -1},
};

int 
main() {
    int i, ntests;

    ntests = sizeof(tests) / sizeof(*tests);
    for (i = 0; i < ntests; i++) {
        const struct test t = tests[i];

        {
            int ny, nm, nd;
            dt_t dt1 = dt_from_ymd(t.y1, t.m1, t.d1);
            dt_t dt2 = dt_from_ymd(t.y2, t.m2, t.d2);

            dt_delta_ymd(dt1, dt2, &ny, &nm, &nd);
            if (!ok((ny == t.ny && nm == t.nm && nd == t.nd),
                "dt_delta_ymd(%.4d-%.2d-%.2d, %.4d-%.2d-%.2d)",
                 t.y1, t.m1, t.d1, t.y2, t.m2, t.d2)) {
                diag("      got: Y:%d, M:%d, D:%d", ny, nm, nd);
                diag("      exp: Y:%d, M:%d, D:%d", t.ny, t.nm, t.nd);
            }
        }

        {
            int nm, em;
            dt_t dt1 = dt_from_ymd(t.y1, t.m1, t.d1);
            dt_t dt2 = dt_from_ymd(t.y2, t.m2, t.d2);

            nm = dt_delta_months(dt1, dt2, 1);
            em = t.nm + (t.ny * 12);
            cmp_ok(nm, "==", em, "dt_delta_months(%.4d-%.2d-%.2d, %.4d-%.2d-%.2d, true)", 
              t.y1, t.m1, t.d1, t.y2, t.m2, t.d2);
        }
    }
    done_testing();
}

